<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="UTF-8">
  <title>ì‹¤ì‹œê°„ ì±„íŒ…</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f8f9fa;
    }

    .chat-box {
      height: 400px;
      overflow-y: auto;
      background-color: #ffffff;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    #messageArea {
      list-style: none;
      padding: 0;
    }

    .message-item {
      padding: 8px 10px;
      margin-bottom: 5px;
      background-color: #f1f1f1;
      border-radius: 5px;
    }

    .message-item.user {
      background-color: #d1f7d1;
    }

    .message-item.other {
      background-color: #f7d1d1;
    }

    .input-group {
      display: flex;
    }

    .input-group input {
      border-radius: 20px 0 0 20px;
    }

    .input-group button {
      border-radius: 0 20px 20px 0;
    }

    .container {
      max-width: 800px;
      margin-top: 40px;
    }
  </style>
</head>
<body>
<div class="container mt-5">
  <h2 class="text-center">ì‹¤ì‹œê°„ ì±„íŒ…</h2>
  <div class="chat-box border p-3 mb-3">
    <ul id="messageArea" class="list-unstyled"></ul>
  </div>
  <div class="input-group mb-2">
    <input type="text" id="message" class="form-control" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." />
    <button class="btn btn-primary" onclick="sendMessage()">ì „ì†¡</button>
  </div>
</div>

<!-- ë™ì ìœ¼ë¡œ ì‚½ì…ëœ ë°ì´í„° ì†ì„± -->
<!-- Thymeleafë¥¼ ì‚¬ìš©í•˜ì—¬ ì„œë²„ì—ì„œ ì „ë‹¬ëœ memberNameì„ ë™ì ìœ¼ë¡œ ì¶œë ¥ -->
<div id="chatRoom" th:data-username="${memberName}" th:data-usercolor="${userColor}"></div>


<script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
<script>
  // ğŸ“Œ URLì—ì„œ roomId ì¶”ì¶œ
  var roomId = window.location.pathname.split("/").pop();
  var username = document.getElementById('chatRoom').getAttribute('data-username');
  var userColor = document.getElementById('chatRoom').getAttribute('data-usercolor');

  console.log("í˜„ì¬ ì±„íŒ…ë°©:", roomId, "ì‚¬ìš©ì:", username, "ìƒ‰ìƒ:", userColor);

  var userColors = {};
  var socket = new SockJS('/ws');
  var stompClient = Stomp.over(socket);

  // ğŸ“Œ ì±„íŒ…ë°© IDì— ë§ëŠ” ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸°
  function loadChatHistory() {
    fetch('/chat/' + roomId + '/messages')  // ğŸ“Œ íŠ¹ì • ì±„íŒ…ë°©ì˜ ë©”ì‹œì§€ë§Œ ê°€ì ¸ì˜´
      .then(response => response.json())
      .then(messages => {
        messages.forEach(chatMessage => {
          displayMessage(chatMessage.sender, chatMessage.content);
        });
      })
      .catch(error => console.error("ì±„íŒ… ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error));
  }

  function displayMessage(sender, content) {
    var messageElement = document.createElement('li');
    messageElement.classList.add('message-item');

    if (!userColors[sender]) {
      userColors[sender] = sender === username ? userColor : getRandomColor();
    }
    messageElement.style.backgroundColor = userColors[sender];

    messageElement.textContent = sender + ": " + content;
    document.getElementById('messageArea').appendChild(messageElement);
  }

  stompClient.connect({}, function (frame) {
    // ğŸ“Œ ê° ì±„íŒ…ë°©ì— ë§ëŠ” êµ¬ë… ì„¤ì •
    stompClient.subscribe('/topic/public/' + roomId, function (message) {
      var chatMessage = JSON.parse(message.body);
      displayMessage(chatMessage.sender, chatMessage.content);
    });

    loadChatHistory();  // ğŸ“Œ ì±„íŒ… ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸°
  });

  function sendMessage() {
    var messageContent = document.getElementById('message').value;
    if (messageContent.trim()) {
      var chatMessage = {
        sender: username,
        content: messageContent,
        type: "CHAT"
      };
      // ğŸ“Œ ê° ì±„íŒ…ë°©ì— ë§ê²Œ ë©”ì‹œì§€ ì „ì†¡
      stompClient.send("/app/chat.sendMessage/" + roomId, {}, JSON.stringify(chatMessage));
      document.getElementById('message').value = '';
    }
  }

  function getRandomColor() {
    var letters = '0123456789ABCDEF';
    var color = '#';
    for (var i = 0; i < 6; i++) {
      color += letters[Math.floor(Math.random() * 16)];
    }
    return color;
  }
</script>
</body>
</html>
